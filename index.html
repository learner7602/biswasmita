<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - EduConnectApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0f4f8;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #333;
    }
    .container {
      max-width: 600px;
      padding: 2rem;
      background-color: white;
      border-radius: 1rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      margin: 2rem;
      width: 100%;
    }
    .main-heading {
      font-size: 2rem;
      font-weight: 700;
      color: #2c5282;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    label {
      font-weight: 600;
      color: #4a5568;
      display: block;
      margin-bottom: 0.5rem;
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      transition: border-color 0.2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #4299e1;
    }
    button {
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s, transform 0.2s;
    }
    .btn-primary {
      background-color: #4299e1;
      color: white;
    }
    .btn-primary:hover {
      background-color: #3182ce;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background-color: #e53e3e;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #c53030;
      transform: translateY(-1px);
    }
    .status-message {
      margin-top: 1.5rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      text-align: center;
      font-weight: 500;
    }
    .status-success {
      background-color: #c6f6d5;
      color: #2f855a;
    }
    .status-error {
      background-color: #fed7d7;
      color: #e53e3e;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div id="admin-login-panel" class="container" style="display: none;">
    <h1 class="main-heading text-center">Admin Sign-In</h1>
    <div class="form-group">
      <label for="adminEmail">Email</label>
      <input type="email" id="adminEmail" placeholder="Enter your email" required>
    </div>
    <div class="form-group">
      <label for="adminPassword">Password</label>
      <input type="password" id="adminPassword" placeholder="Enter your password" required>
    </div>
    <button id="adminSignInBtn" class="btn-primary w-full">Sign In</button>
    <div id="loginStatus" class="status-message hidden mt-4"></div>
  </div>

  <div id="admin-dashboard" class="container" style="display: none;">
    <div class="flex justify-between items-center mb-6">
      <h1 class="main-heading">Admin Panel</h1>
      <button id="signOutBtn" class="btn-secondary">Sign Out</button>
    </div>

    <div class="form-group">
      <label for="classSelect">Select Class</label>
      <select id="classSelect" class="w-full">
        <option value="V">Class V</option>
        <option value="VI">Class VI</option>
        <option value="VII">Class VII</option>
        <option value="VIII">Class VIII</option>
        <option value="IX">Class IX</option>
        <option value="X">Class X</option>
        <option value="XI">Class XI</option>
        <option value="XII">Class XII</option>
      </select>
    </div>
    
    <div class="space-y-6">
      <div class="p-6 bg-gray-50 rounded-lg">
        <h2 class="text-lg font-bold mb-4 text-gray-800">Set Live Class Link</h2>
        <div class="flex flex-col md:flex-row md:space-x-4">
          <input type="url" id="liveClassLinkInput" placeholder="Paste live class link here..." class="flex-1">
          <button id="saveLinkBtn" class="btn-primary mt-4 md:mt-0">Save Link</button>
        </div>
      </div>
      
      <div class="p-6 bg-gray-50 rounded-lg">
        <h2 class="text-lg font-bold mb-4 text-gray-800">Add Resources</h2>
        <div class="space-y-4">
          <input type="text" id="resourceTitle" placeholder="Resource Title (e.g., Chapter 1 Notes)">
          <input type="url" id="resourceLink" placeholder="Google Drive Link or URL">
          <button id="addResourceBtn" class="btn-primary w-full">Add Resource</button>
        </div>
      </div>
    </div>
    
    <div id="statusMsg" class="status-message hidden"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyApjKA34mwvz_gWH9V0RY4wHbmMEP6oqRg",
      authDomain: "educonnectapp-ae08d.firebaseapp.com",
      projectId: "educonnectapp-ae08d",
      storageBucket: "educonnectapp-ae08d.firebasestorage.app",
      messagingSenderId: "10974354104",
      appId: "1:10974354104:web:228ca789dfb241f43ff24d",
      measurementId: "G-XMDY71K3ZR"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginPanel = document.getElementById("admin-login-panel");
    const dashboardPanel = document.getElementById("admin-dashboard");
    const adminEmailInput = document.getElementById("adminEmail");
    const adminPasswordInput = document.getElementById("adminPassword");
    const adminSignInBtn = document.getElementById("adminSignInBtn");
    const loginStatusMsg = document.getElementById("loginStatus");

    const classSelect = document.getElementById("classSelect");
    const liveClassLinkInput = document.getElementById("liveClassLinkInput");
    const saveLinkBtn = document.getElementById("saveLinkBtn");
    const resourceTitle = document.getElementById("resourceTitle");
    const resourceLink = document.getElementById("resourceLink");
    const addResourceBtn = document.getElementById("addResourceBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const statusMsg = document.getElementById("statusMsg");

    function displayMessage(element, message, isError = true) {
      element.innerText = message;
      element.classList.remove("hidden");
      element.classList.toggle("status-error", isError);
      element.classList.toggle("status-success", !isError);
    }

    // --- Core Logic for Admin Access ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          // Check if the signed-in user is an admin by looking for their UID in the 'admins' collection
          const adminDoc = await db.collection("admins").doc(user.uid).get();
          if (adminDoc.exists) {
            // User is an admin, show the dashboard and hide the login panel
            loginPanel.style.display = 'none';
            dashboardPanel.style.display = 'block';
          } else {
            // User is not an admin, sign them out and show an error
            await auth.signOut();
            displayMessage(loginStatusMsg, "❌ Access Denied: This account is not an administrator.", true);
            loginPanel.style.display = 'block';
            dashboardPanel.style.display = 'none';
          }
        } catch (error) {
          console.error("Error during admin check:", error);
          await auth.signOut();
          displayMessage(loginStatusMsg, "❌ An error occurred. Please try again.", true);
          loginPanel.style.display = 'block';
          dashboardPanel.style.display = 'none';
        }
      } else {
        // No user is signed in, show the login panel
        loginPanel.style.display = 'block';
        dashboardPanel.style.display = 'none';
      }
    });

    // --- Admin Sign-In Functionality ---
    adminSignInBtn.addEventListener("click", async () => {
      const email = adminEmailInput.value;
      const password = adminPasswordInput.value;
      if (!email || !password) {
        displayMessage(loginStatusMsg, "⚠️ Please enter both email and password.", true);
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
        // The onAuthStateChanged listener will handle the rest
        displayMessage(loginStatusMsg, "✅ Signing in...", false);
      } catch (error) {
        let errorMessage = "❌ Incorrect credentials. Please try again.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          errorMessage = "❌ Incorrect email or password.";
        }
        displayMessage(loginStatusMsg, errorMessage, true);
        console.error("Login error:", error);
      }
    });

    // --- Existing Admin Panel Functions ---
    saveLinkBtn.addEventListener("click", async () => {
      const classId = `Class-${classSelect.value}`;
      const link = liveClassLinkInput.value;
      if (!link) {
        displayMessage(statusMsg, "⚠️ Please enter a link.", true);
        return;
      }
      try {
        await db.collection(classId).doc("liveClass").set({ link });
        displayMessage(statusMsg, "✅ Live class link saved successfully!", false);
      } catch (error) {
        console.error("Error saving link:", error);
        displayMessage(statusMsg, "❌ Error saving link. Check your permissions.", true);
      }
    });

    addResourceBtn.addEventListener("click", async () => {
      const classId = `Class-${classSelect.value}`;
      const title = resourceTitle.value;
      const link = resourceLink.value;
      if (!title || !link) {
        displayMessage(statusMsg, "⚠️ Please enter both a title and a link.", true);
        return;
      }
      try {
        await db.collection(classId).doc("resources").collection("items").add({
          title,
          link,
          uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        displayMessage(statusMsg, "✅ Resource added successfully!", false);
        resourceTitle.value = "";
        resourceLink.value = "";
      } catch (error) {
        console.error("Error adding resource:", error);
        displayMessage(statusMsg, "❌ Error adding resource. Check your permissions.", true);
      }
    });

    signOutBtn.addEventListener("click", async () => {
      try {
        await auth.signOut();
        // The onAuthStateChanged listener will automatically redirect to the login form
      } catch (error) {
        console.error("Error signing out:", error);
        alert("Error signing out. Please try again.");
      }
    });
  </script>
</body>
</html>
